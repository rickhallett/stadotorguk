---
import Layout from "../layouts/Layout.astro";
import DataBlock from "../components/DataBlock.astro";
import BrutalSection from "../components/BrutalSection.astro";
import ImpactCard from "../components/ImpactCard.astro";
---

<Layout title="Home">
  <!-- HERO SECTION -->
  <section class="hero">
    <div class="hero-grid">
      {[...Array(9)].map(() => <div class="grid-cell" />)}
    </div>
    <div class="hero-content">
      <h1 class="brutal-headline">SWANAGE<br />TRAFFIC<br />ALLIANCE</h1>
      <div style="">
        <p class="brutal-subhead">OPENing DIALOGUE</p>
        <p class="brutal-subhead">FOSTERING TRANSPARENCY</p>
      </div>
      <div class="data-block" style="opacity: 1; transform: none;">
        <!-- <div class="data-label">The Electorate's engagement = change</div> -->
        <div class="data-stat">We are all affected</div>
      </div>
    </div>
  </section>

  <!-- SCROLL INDICATOR -->
  <div class="scroll-indicator"></div>

  <!-- INTRODUCTION -->
  <section class="story-section fade-in">
    <div class="story-content">
      <div>
        <h2 class="brutal-subhead">THE ALLIANCE</h2>
        <p style="font-size: 1.25rem; margin: 2rem 0; line-height: 1.6;">
          The Swanage Traffic Alliance amplifies your voice, tracks council
          accountability, and gives regular updates on progress. We focus on
          traffic challenges, parking frustrations, and fair use of highways
          funding to influence council deliberations through a unified community
          effort.
        </p>
        <!-- <div class="pull-quote">
          "Why can't I get the problems on my road fixed?"<span
            style="font-size: 1.75rem; opacity: 0.4;">~ Margaret S.</span
          >
        </div> -->
        <!-- <p style="font-size: 1.25rem; opacity: 0.5">~ Margaret S</p> -->
      </div>
      <DataBlock label="ACTIVE MEMBERS" stat="623" description="" />
    </div>
  </section>

  <!-- TRAFFIC SURGE -->
  <!-- <BrutalSection title="THE £75,000 DECEPTION">
    <div class="chart-container">
      <h3 class="brutal-subhead">DCF SURVEY EXPOSED</h3>
      <div class="bar-chart">
        <div class="bar" style="height: 30%;" data-value="387">
          <span class="bar-value">387</span>
          <span class="bar-label">Total Responses</span>
        </div>
        <div class="bar" style="height: 60%;" data-value="71%">
          <span class="bar-value">71%</span>
          <span class="bar-label">Were Visitors</span>
        </div>
        <div class="bar" style="height: 90%;" data-value="10,000+">
          <span class="bar-value">10,000+</span>
          <span class="bar-label">Residents Ignored</span>
        </div>
      </div>
    </div>
    <div class="brutal-info-block">
      <h3 class="brutal-subhead">EVIDENCE OF CORRUPTION</h3>
      <ul style="font-size: 1.25rem; margin-top: 1rem; list-style: none;">
        <li style="margin-bottom: 1rem;">
          ▪ Survey conducted during PEAK TOURIST SEASON
        </li>
        <li style="margin-bottom: 1rem;">
          ▪ Technical failures documented by Granicus Ltd
        </li>
        <li style="margin-bottom: 1rem;">
          ▪ Standing Order 1c used to silence critics
        </li>
        <li>▪ UK Statistics Authority investigating complaints</li>
      </ul>
    </div>
  </BrutalSection> -->

  <!-- IMPACT ANALYSIS -->
  <!-- <BrutalSection title="DORSET HIGHWAYS FUNDING ANALYSIS">
    <div class="impact-grid">
      <ImpactCard
        stat="£75,000"
        description="Allocated to flawed survey feasibility"
      />
      <ImpactCard stat="£500,000" description="Total funds at risk" />
    </div>
  </BrutalSection> -->

  <!-- PARKING CRISIS -->
  <!-- <BrutalSection title="THE DEMOCRATIC DEFICIT">
    <div class="evidence-grid">
      <div class="evidence-card">
        <div class="evidence-number">1</div>
        <h3 style="font-size: 1.5rem; margin-bottom: 1rem;">
          SURVEY MANIPULATION
        </h3>
        <div class="data-stat" style="font-size: 3rem;">?</div>
        <p style="margin-top: 1rem;">Responses used to justify £75,000 spend</p>
      </div>
      <div class="evidence-card">
        <div class="evidence-number">2</div>
        <h3 style="font-size: 1.5rem; margin-bottom: 1rem;">VISITOR BIAS</h3>
        <div class="data-stat" style="font-size: 3rem;">?</div>
        <p style="margin-top: 1rem;">
          Survey respondents were tourists, not residents
        </p>
      </div>
      <div class="evidence-card">
        <div class="evidence-number">3</div>
        <h3 style="font-size: 1.5rem; margin-bottom: 1rem;">
          COUNCIL TRANSPARENCY
        </h3>
        <div class="data-stat" style="font-size: 3rem;">0</div>
        <p style="margin-top: 1rem;">
          Minutes of public consultation published <span
            style="font-size: 0.8rem; opacity: 0.6;"
            >(we'll see about that...)</span
          >
        </p>
      </div>
    </div>
  </BrutalSection> -->

  <!-- CALL TO ACTION -->
  <BrutalSection>
    <h2
      class="brutal-headline"
      style="font-size: clamp(3rem, 8vw, 5rem); text-align: center;"
    >
      <span></span><br />Join the alliance
    </h2>

    <div class="action-form">
      <form id="contactForm">
        <div class="form-group">
          <label for="name">NAME *</label>
          <input
            type="text"
            id="name"
            name="name"
            required
            maxlength="100"
            pattern="[A-Za-z\s]+"
            title="Please enter a valid name"
          />
          <span class="error-message" data-for="name"></span>
        </div>
        <div class="form-group">
          <label for="email">EMAIL *</label>
          <input
            type="email"
            id="email"
            name="email"
            required
            maxlength="255"
          />
          <span class="error-message" data-for="email"></span>
        </div>
        <div class="form-group">
          <label for="postcode">POSTCODE *</label>
          <input
            type="text"
            id="postcode"
            name="postcode"
            required
            title="Please enter a valid UK postcode"
            maxlength="10"
          />
          <span class="error-message" data-for="postcode"></span>
        </div>
        <div class="form-group">
          <label for="message">YOUR STORY (OPTIONAL)</label>
          <textarea id="message" name="message" rows="4" maxlength="1000"
          ></textarea>
          <small>Characters remaining: <span id="charCount">1000</span></small>
        </div>
        <button type="submit" class="submit-btn">STAND WITH US</button>
      </form>
      <div
        class="form-confirmation"
        id="formConfirmation"
        style="display: none;"
      >
        CONFIRMED: YOU ARE NOW PART OF THE ALLIANCE
      </div>
    </div>
  </BrutalSection>
</Layout>

<style>
  /* HERO SECTION */
  .hero {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: var(--brutal-black);
    color: var(--brutal-white);
    padding: 2rem;
    position: relative;
    overflow: hidden;
  }

  .hero-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2px;
    position: absolute;
    inset: 0;
    opacity: 0.1;
  }

  .grid-cell {
    background: var(--brutal-white);
    border: 1px solid var(--brutal-white);
  }

  .hero-content {
    position: relative;
    z-index: 10;
    max-width: 1400px;
    margin: 0 auto;
  }

  .hero .brutal-headline {
    margin-bottom: 2rem;
    animation: slideInBrutal 1s ease-out forwards;
  }

  /* STORY SECTIONS */
  .story-section {
    min-height: 50vh;
    display: flex;
    align-items: center;
    padding: 4rem 2rem;
  }

  .story-content {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 4rem;
    align-items: center;
  }

  /* CHARTS */
  .chart-container {
    margin: 2rem 0;
  }

  .bar-chart {
    display: flex;
    align-items: flex-end;
    height: 300px;
    gap: 1rem;
    padding: 3rem;
    background: var(--brutal-white);
    border: 4px solid var(--brutal-black);
    margin-top: 1rem;
  }

  .bar {
    flex: 1;
    background: var(--brutal-gray); /* Green for positive growth */
    position: relative;
    transition: all 0.8s ease-out;
  }

  .bar-label {
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.875rem;
    white-space: nowrap;
  }

  .bar-value {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    font-weight: 900;
    font-size: 1.25rem;
  }

  /* BRUTAL INFO BLOCK */
  .brutal-info-block {
    background: var(--brutal-concrete);
    border: 4px solid var(--brutal-black);
    padding: 2rem;
    margin: 2rem 0;
  }

  .brutal-info-block h3 {
    margin-bottom: 1rem;
  }

  /* IMPACT GRID */
  .impact-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 2rem;
    margin: 3rem 0;
  }

  /* EVIDENCE CARDS */
  .evidence-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin: 3rem 0;
  }

  .evidence-card {
    background: var(--brutal-concrete);
    border: 4px solid var(--brutal-black);
    padding: 2rem;
    position: relative;
    overflow: hidden;
  }

  .evidence-number {
    position: absolute;
    top: -20px;
    right: 20px;
    font-size: 6rem;
    font-weight: 900;
    color: #ffd700; /* Golden yellow */
    opacity: 0.2;
  }

  /* SCROLL INDICATOR */
  .scroll-indicator {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 60px;
    border: 4px solid var(--brutal-black);
    background: var(--brutal-white);
    opacity: 0.8;
    animation: bounce 2s infinite;
    z-index: 50;
  }

  .scroll-indicator::before {
    content: "";
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 8px;
    height: 8px;
    background: var(--brutal-black);
    animation: scrollDot 2s infinite;
  }

  @keyframes bounce {
    0%,
    100% {
      transform: translateX(-50%) translateY(0);
    }
    50% {
      transform: translateX(-50%) translateY(10px);
    }
  }

  @keyframes scrollDot {
    0% {
      top: 10px;
    }
    50% {
      top: 30px;
    }
    100% {
      top: 10px;
    }
  }

  /* Form Styles */
  .action-form {
    background: var(--brutal-white);
    border: 8px solid var(--brutal-black);
    box-shadow: 15px 15px 0 var(--brutal-shadow);
    padding: 3rem;
    margin: 2rem 0;
  }

  .form-group {
    margin-bottom: 2rem;
  }

  .form-group label {
    display: block;
    font-family: "Arial Black", sans-serif;
    font-size: 1.2rem;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: -2px;
    margin-bottom: 0.5rem;
    color: var(--brutal-black);
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 1rem;
    border: 4px solid var(--brutal-black);
    font-size: 1rem;
    font-family: "Arial", sans-serif;
    background: var(--brutal-white);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    box-shadow: 8px 8px 0 var(--brutal-shadow);
    transform: translate(-2px, -2px);
  }

  .form-group small {
    display: block;
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: var(--brutal-gray);
  }

  .error-message {
    color: var(--brutal-red);
    font-weight: bold;
    margin-top: 0.5rem;
    font-size: 0.9rem;
    text-transform: uppercase;
    display: none;
  }

  .error-message.show {
    display: block;
  }

  .submit-btn {
    background: var(--brutal-red);
    color: var(--brutal-white);
    border: 4px solid var(--brutal-black);
    padding: 1.5rem 3rem;
    font-family: "Arial Black", sans-serif;
    font-size: 1.5rem;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: -2px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 8px 8px 0 var(--brutal-black);
  }

  .submit-btn:hover {
    transform: translate(-4px, -4px);
    box-shadow: 12px 12px 0 var(--brutal-black);
  }

  .submit-btn:active {
    transform: translate(0, 0);
    box-shadow: 4px 4px 0 var(--brutal-black);
  }

  .submit-btn:disabled {
    background: var(--brutal-gray);
    cursor: not-allowed;
    opacity: 0.7;
  }

  .form-confirmation {
    background: var(--brutal-black);
    color: var(--brutal-white);
    border: 4px solid var(--brutal-red);
    padding: 2rem;
    text-align: center;
    font-family: "Arial Black", sans-serif;
    font-size: 1.5rem;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: -2px;
    margin-top: 2rem;
    animation: confirmSlam 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes confirmSlam {
    0% {
      transform: scale(0) rotate(-5deg);
      opacity: 0;
    }
    50% {
      transform: scale(1.1) rotate(2deg);
    }
    100% {
      transform: scale(1) rotate(0);
      opacity: 1;
    }
  }

  @media (max-width: 768px) {
    /* Reduce hero section padding and height dramatically */
    .hero {
      min-height: 65vh; /* Remove 100vh constraint */
      padding: 2rem 1rem; /* Add some vertical padding instead of centering */
      justify-content: center; /* Align content to top instead of center */
    }

    /* Reduce hero headline bottom margin by 50% */
    .hero .brutal-headline {
      margin-bottom: 1rem;
    }

    /* Reduce story section padding by 50% */
    .story-section {
      padding: 2rem 1rem;
    }

    .story-content {
      grid-template-columns: 1fr;
      gap: 1rem; /* Reduced from 2rem */
    }

    .bar-chart {
      height: 200px;
    }

    /* Form mobile styles */
    .action-form {
      padding: 1.5rem;
      margin: 1rem;
      box-shadow: 8px 8px 0 var(--brutal-shadow);
    }

    .form-group label {
      font-size: 1rem;
    }

    .submit-btn {
      width: 100%;
      font-size: 1.2rem;
      padding: 1rem 2rem;
    }

    .form-confirmation {
      font-size: 1.2rem;
      padding: 1.5rem;
    }
  }
</style>

<script>
  // Character counter for message field
  const messageField = document.getElementById(
    "message"
  ) as HTMLTextAreaElement;
  const charCountSpan = document.getElementById("charCount");

  if (messageField && charCountSpan) {
    messageField.addEventListener("input", () => {
      const remaining = 1000 - messageField.value.length;
      charCountSpan.textContent = remaining.toString();
    });
  }

  // Form handling
  document
    .getElementById("contactForm")
    ?.addEventListener("submit", async function (e) {
      e.preventDefault();

      const form = this as HTMLFormElement;
      const submitBtn = form.querySelector(".submit-btn") as HTMLButtonElement;
      const confirmation = document.getElementById("formConfirmation");

      // Get form data
      const nameValue = (document.getElementById("name") as HTMLInputElement)
        .value;
      const nameParts = nameValue.trim().split(" ");

      const formData = {
        first_name: nameParts[0],
        last_name: nameParts.slice(1).join(" ") || "",
        email: (document.getElementById("email") as HTMLInputElement).value,
        postcode: (document.getElementById("postcode") as HTMLInputElement)
          .value,
        comments: (document.getElementById("message") as HTMLTextAreaElement)
          .value,
      };

      // Show loading state
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = "PROCESSING...";
      }

      try {
        // Submit to API
        const response = await fetch("/api/submit-lead", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData),
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Show confirmation
          if (confirmation) {
            form.style.display = "none";
            confirmation.style.display = "block";
          }

          // Reset form
          form.reset();
          if (charCountSpan) charCountSpan.textContent = "1000";

          // Hide confirmation after 5 seconds and show form again
          setTimeout(() => {
            if (confirmation) {
              confirmation.style.display = "none";
              form.style.display = "block";
            }
          }, 5000);

          console.log("Lead submitted successfully:", result.submission_id);
        } else {
          // Handle API errors
          const errorMsg =
            result.error || "Submission failed. Please try again.";
          alert(errorMsg);
          console.error("Submission error:", result);
        }
      } catch (error) {
        // Handle network errors
        alert(
          "There was an error submitting your information. Please try again later."
        );
        console.error("Network error:", error);
      } finally {
        // Reset button state
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "STAND WITH US";
        }
      }
    });

  // Hide scroll indicator on scroll
  window.addEventListener("scroll", () => {
    const indicator = document.querySelector(
      ".scroll-indicator"
    ) as HTMLElement;
    if (indicator) {
      if (window.scrollY > 100) {
        indicator.style.opacity = "0";
      } else {
        indicator.style.opacity = "0.8";
      }
    }
  });

  // Parallax effect for hero grid
  window.addEventListener("scroll", () => {
    const scrolled = window.pageYOffset;
    const grid = document.querySelector(".hero-grid") as HTMLElement;
    if (grid) {
      grid.style.transform = `translateY(${scrolled * 0.5}px)`;
    }
  });
</script>
